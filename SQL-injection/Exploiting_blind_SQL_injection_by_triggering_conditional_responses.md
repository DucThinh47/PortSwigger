# Exploiting blind SQL injection by triggering conditional responses

Giả sử một ứng dụng sử dụng **cookie theo dõi** (tracking cookies) để thu thập dữ liệu phân tích về người dùng. Mỗi yêu cầu gửi đến ứng dụng đều chứa tiêu đề cookie như sau:

    Cookie: TrackingId=u5YD3PapBcR4lN3e7Tj4

Khi nhận được yêu cầu có **TrackingId**, ứng dụng sử dụng một truy vấn SQL để kiểm tra xem ID này có trong cơ sở dữ liệu hay không:

    SELECT TrackingId FROM TrackedUsers WHERE TrackingId = 'u5YD3PapBcR4lN3e7Tj4'

Truy vấn này dễ bị **SQL injection**, nhưng **kết quả của truy vấn không được hiển thị** trực tiếp cho người dùng. Tuy nhiên, ứng dụng có **hành vi khác nhau** dựa trên việc truy vấn có trả về dữ liệu hay không.

- Nếu TrackingId hợp lệ (có trong cơ sở dữ liệu), truy vấn trả về dữ liệu và phản hồi chứa thông báo **"Welcome back"**.

- Nếu TrackingId không hợp lệ, phản hồi không chứa thông báo này.

Dựa vào sự khác biệt trong phản hồi của ứng dụng, kẻ tấn công có thể **khai thác lỗ hổng Blind SQL Injection bằng cách tiêm các điều kiện vào truy vấn và phân tích phản hồi để truy xuất thông tin bí mật**.

# Exploiting blind SQL injection by triggering conditional responses - Continued

Để hiểu rõ cách khai thác này, giả sử kẻ tấn công gửi hai yêu cầu chứa giá trị **TrackingId** như sau:

    …xyz' AND '1'='1
    …xyz' AND '1'='2

**Yêu cầu đầu tiên (xyz' AND '1'='1)**:

- Điều kiện **AND '1'='1'** luôn đúng => Truy vấn SQL **trả về kết quả**.

- Ứng dụng phản hồi với thông báo **"Welcome back"**.

**Yêu cầu thứ hai (xyz' AND '1'='2)**

- Điều kiện **AND '1'='2'** luôn sai => Truy vấn **không trả về kết quả**.

- Ứng dụng không hiển thị thông báo **"Welcome back"**.

Dựa vào sự khác biệt trong phản hồi, kẻ tấn công có thể **xác định câu lệnh SQL có đúng hay không**, từ đó **trích xuất dữ liệu từng phần** bằng cách thay đổi điều kiện trong payload injected.

# Exploiting blind SQL injection by triggering conditional responses - Continued

Giả sử có một bảng **Users** chứa các cột **Username** và **Password**, trong đó có một tài khoản **Administrator**. Kẻ tấn công có thể xác định mật khẩu của tài khoản này bằng cách kiểm tra từng ký tự một.

**Bước 1: Kiểm tra ký tự đầu tiên của mật khẩu**

Bắt đầu với payload sau:

    xyz' AND SUBSTRING((SELECT Password FROM Users WHERE Username = 'Administrator'), 1, 1) > 'm

- Nếu nhận được phản hồi **"Welcome back"**, điều này có nghĩa là **ký tự đầu tiên của mật khẩu lớn hơn 'm'** theo thứ tự bảng chữ cái.

Sau đó, thử với payload khác:

    xyz' AND SUBSTRING((SELECT Password FROM Users WHERE Username = 'Administrator'), 1, 1) > 't

- Nếu không nhận được phản hồi **"Welcome back"**, điều này có nghĩa là **ký tự đầu tiên không lớn hơn 't'**.

Tiếp tục thu hẹp phạm vi bằng cách thử với ký tự cụ thể:

    xyz' AND SUBSTRING((SELECT Password FROM Users WHERE Username = 'Administrator'), 1, 1) = 's

- Nếu nhận được phản hồi **"Welcome back"**, thì **ký tự đầu tiên của mật khẩu là 's'**.

**Bước 2: Xác định các ký tự tiếp theo**

Lặp lại quy trình trên với các vị trí tiếp theo của mật khẩu, thay đổi chỉ mục trong hàm **SUBSTRING()**, ví dụ:

    xyz' AND SUBSTRING((SELECT Password FROM Users WHERE Username = 'Administrator'), 2, 1) > 'm

Dần dần, kẻ tấn công có thể xác định toàn bộ mật khẩu của tài khoản **Administrator**.

**Lưu ý**: Trong một số hệ quản trị cơ sở dữ liệu, hàm SUBSTRING() có thể được viết là SUBSTR(). 

# Lab: Blind SQL injection with conditional responses

![img](101)

Truy cập lab: 

![img](102)

Click category Lifestyle và intercept request này trong Burp Suite: 

![img](103)

=> Website có sử dụng tracking cookies để thu thập dữ liệu phân tích về người dùng. 

Send request, quan sát response: 

![img](104)

=> Website phản hồi với thông báo "Welcome back". 

Thử chỉnh sửa cookie TrackingId thành **TrackingId=...' AND '1'='1**: 

![img](105)

Send request, quan sát response: 

![img](106)

=> Website vẫn phản hồi với thông báo "Welcome back".

Thử chỉnh sửa cookie TrackingId thành **TrackingId=...' AND '1'='2**: 

![img](107)

Send request, quan sát response: 

![img](108)

=> Webiste không còn phản hồi thông báo "Welcome back".

=> Có thể lợi dụng cách website phản hồi để kiểm trâ và chèn payload phù hợp. 

Thử chèn payload **' AND (SELECT 'a' FROM users LIMIT 1)='a**: 

![img](109)

Send request, quan sát response: 

![img](110)

=> Website phản hồi với thông báo "Welcome back", nghĩa là có tồn tại bảng users trong CSDL. 

Tiếp theo thử chèn payload **' AND (SELECT 'a' FROM users WHERE username='administrator')='a** để xác nhận xem có username là administrator trong bảng users không: 

![img](111)

Send request, quan sát response: 

![img](112)

=> Website phản hồi thông báo "Welcome back", nghĩa là có tồn tại username=administrator trong bảng users. 

Tiếp theo cần tìm password, thử chèn payload **' AND (SELECT 'a' FROM users WHERE username='administrator' AND LENGTH(password)>1)='a**: 

![img](113)

Send request, quan sát response: 

![img](114)

=> Website phản hồi thông báo "Welcome back", xác nhận password của administrator có độ dài > 1. 

Tiếp theo thử chèn payload **' AND (SELECT 'a' FROM users WHERE username='administrator' AND LENGTH(password)>10)='a**: 

![img](115)

Send request, quan sát response: 

![img](116)

=> Website phản hồi thông báo "Welcome back", xác nhận password của administrator có độ dài > 10.

Tiếp theo thử chèn payload **' AND (SELECT 'a' FROM users WHERE username='administrator' AND LENGTH(password)>20)='a**: 

![img](117)

Send request, quan sát response: 

![img](118)

=> Website không còn phản hồi thông báo "Welcome back", nghĩa là độ dài password là 20. 

Tiếp theo cần kiểm tra ký tự ở mỗi vị trí để xác định giá trị của nó. Chèn payload **' AND (SELECT SUBSTRING(password,1,1) FROM users WHERE username='administrator')='a** và send request tới Intruder. Đặt vị trí brute-force là ở vị trí kí tự của chuỗi password và kí tự 'a: 

![img](119)

Chọn kiểu attack là Cluster bomb. Setting payload cho vị trí kí tự trong chuỗi password: 

![img](120)

Setting payload cho giá trị tương ứng với vị trí kí tự đó: 

![img](121)

Start attack: 

![img](122)

Setting để lọc ra lần thử có phản hồi chứa "Welcome back":

![img](123)

Tìm được kí tự đầu tiên của password: 

![img](124)

Tiếp tục làm tương tự với các vị trí còn lại, ví dụ chỉnh thành vị trí ký tự thứ 2 trong chuỗi password và thực hiện brute-force lại:

![img](125)

=> Tìm ra password là: l7b7sximsk0a8s7en7j9

Login account administrator: 

![img](126)

Solved the lab!

![img](127)

1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20
l7b7sximsk0a8s7en7j9

